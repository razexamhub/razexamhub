<script type="module">
  import emailjs from 'https://esm.sh/@emailjs/browser';

  emailjs.init("cog20Tx1ONd3oFBb6");

  document.getElementById("checkoutForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const email = document.getElementById("email").value.trim();
    const address = document.getElementById("address").value.trim();
    const cart = JSON.parse(localStorage.getItem("cart")) || [];

    if (cart.length === 0) {
      alert("Your cart is empty.");
      return;
    }

    const shippingCharge = 40;
    const subtotal = cart.reduce((sum, item) => sum + (parseFloat(item.price) * item.qty), 0);
    const taxAmount = Math.round(subtotal * 0.12); // 12%
    const totalAmount = subtotal + shippingCharge + taxAmount;

    const orderId = "ORD" + Math.floor(Math.random() * 1000000);

    const orders = cart.map(item => ({
      name: item.name,
      units: item.qty,
      price: parseFloat(item.price) * item.qty,
      image_url: item.image || "https://via.placeholder.com/80"
    }));

    const rzp = new Razorpay({
      key: "rzp_test_stSgFyQjlpFMEy",
      amount: totalAmount * 100,
      currency: "INR",
      name: "munu",
      description: "Order Payment",
      prefill: {
        name,
        email,
        contact: phone
      },
      theme: { color: "#2c3e50" },
      handler: function (response) {
        const paymentId = response.razorpay_payment_id || "N/A";

        emailjs.send("service_qupgv9m", "template_t4eh97j", {
          order_id: orderId,
          orders,
          name,
          email,
          address,
          phone,
          payment_id: paymentId,
          cost: {
            total: totalAmount,
            tax: taxAmount,
            shipping: shippingCharge
          }
        }).then(() => {
          alert("âœ… Payment successful. Confirmation email sent.");
          localStorage.removeItem("cart");
          window.location.href = "index.html";
        }, (error) => {
          alert("Payment successful, but email failed: " + error.text);
        });
      }
    });

    rzp.open();
  });
</script>
